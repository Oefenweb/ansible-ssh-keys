---

- block:
    - name: Generate private ssh key
      shell:
        "{{ ssh_keys_generate_command | default(_ssh_keys_generate_command) }}"
      when: >-
        item.force | bool or
        item.path is not file
      with_items: "{{ ssh_keys_generate_keys }}"

    - name: Set permissions on keys
      file:
        path: "{{ item.path }}"
        owner: "{{ item.owner }}"
        group: "{{ item.group | default(item.owner) }}"
        mode: "{{ item.mode | default('0600') }}"
      with_items: "{{ ssh_keys_generate_keys }}"

    - name: Generate public ssh key
      openssl_publickey:
        path: "{{ item.path }}.pub"
        force: "{{ item.force | default(false) }}"
        format: "{{ item.format | default('OpenSSH') }}"
        # comment: "{{ item.comment | default(omit) }}"
        owner: "{{ item.owner }}"
        group: "{{ item.group | default(item.owner) }}"
        mode: "{{ item.mode | default(0600) }}"
        privatekey_passphrase: "{{ item.passphrase | default(omit) }}"
        privatekey_path: "{{ item.path }}"
      with_items: "{{ ssh_keys_generate_keys }}"
  delegate_to: localhost
