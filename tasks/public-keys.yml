# tasks file for ssh-keys
---
- name: filter users with public_keys attribute
  set_fact:
    ssh_keys_users_with_public_keys: "{{ ssh_keys_users | selectattr('public_keys', 'defined') | list }}"
  tags: [configuration, ssh-keys, ssh-keys-public-keys]

- name: add public keys
  copy:
    src: "{{ item.1.src }}"
    dest: "{{ item.0.home }}/{{ ssh_keys_sshdir }}/{{ item.1.dest }}"
    owner: "{{ item.0.owner }}"
    group: "{{ item.0.group | default(item.0.owner) }}"
    mode: 0644
  with_subelements:
    - ssh_keys_users_with_public_keys
    - public_keys
  when: item.1.state == 'present'
  tags: [configuration, ssh-keys, ssh-keys-public-keys]

- name: remove public keys
  file:
    path: "{{ item.0.home }}/{{ ssh_keys_sshdir }}/{{ item.1.dest }}"
    state: absent
  with_subelements:
    - ssh_keys_users_with_public_keys
    - public_keys
  when: item.1.state == 'absent'
  tags: [configuration, ssh-keys, ssh-keys-public-keys]
